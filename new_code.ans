$abstractClass create ::constcl::Port {
  superclass ::constcl::Base
  variable handle
  constructor {args} {
    ::if {[llength $args]} {
      lassign $args handle
    } else {
      set handle ${::#NIL}
    }
  }
  method query {keyword} {
    switch $keyword {
      handle {return $handle}
      default {
        return [next $keyword]
      }
    }
  }
  method config {keyword val} {
    switch $keyword {
      default {
        return [next $keyword $val]
      }
    }
  }
}

oo::class create ::constcl::InputPort {
  superclass ::constcl::Port
  variable handle
  constructor {h} {
    set handle $h
  }
  method write {val {port {}}} {
    regexp {(\d+)} [self] -> num
    return "#<input-port-$num>"
  }
  method display {val {port {}}} {
    my write {}
  }
  method query {keyword} {
    switch $keyword {
      get {
        assert "$handle stands for an open channel" [expr {$handle in [chan names]}]
        chan read $handle 1
      }
      eof {
        assert "$handle stands for an open channel" [expr {$handle in [chan names]}]
        chan eof $handle
      }
      method copy {
        ::constcl::InputPort new $handle
      }
      default {
        return [next $keyword]
      }
    }
  }
  method config {keyword val} {
    switch $keyword {
      handle -
      open {
        try {
          $val query string
        } on ok filename {
          try {
            open $filename r
          } on ok f {
            set handle $f
          } on error msg {
            set handle ${::#NIL}
            ::error $msg
          }
        } on error msg {
          ::error $msg
        }
      }
    }
    close {
      catch {close $handle}
      set handle ${::#NIL}
    }
    default {
      return [next $keyword $val]
    }
  }
}
interp alias {} ::constcl::MkInputPort \
  {} ::constcl::InputPort new
oo::class create ::constcl::StringInputPort {
  superclass ::constcl::Port
  variable buffer read_eof
  constructor {str} {
    set buffer $str
    set read_eof 0
  }
  method open {name} {}
  method close {} {}
  method get {} {
    ::if {[::string length $buffer] == 0} {
      set read_eof 1
      return ${::#EOF}
    }
    set c [::string index $buffer 0]
    set buffer [::string range $buffer 1 end]
    return $c
  }
  method eof {} {
    return $read_eof
  }
  method copy {} {
    ::constcl::StringInputPort new $buffer
  }
  method tstr {} {
    regexp {(\d+)} [self] -> num
    return "#<string-input-port-$num>"
  }
}
interp alias {} ::constcl::MkStringInputPort \
  {} ::constcl::StringInputPort new
oo::class create ::constcl::OutputPort {
  superclass ::constcl::Port
  variable handle
  constructor {h} {
    set handle $h
  }
  method write {val {port {}}} {
    regexp {(\d+)} [self] -> num
    return "#<output-port-$num>"
  }
  method open {name} {
    ::error "remove this line to use"
    set handle ${::#NIL}
    try {
      $name value
    } on ok filename {
      try {
        open $filename "w"
      } on ok f {
        set handle $f
      } on error msg {
        ::error $msg
        set handle ${::#NIL}
      }
    } on error msg {
      ::error $msg
    }
    return $handle
  }
  method put {str} {
    puts -nonewline $handle $str
  }
  method newline {} {
    puts $handle {}
  }
  method flush {} {
    flush $handle
  }
  method copy {} {
    ::constcl::OutputPort new $handle
  }
}
interp alias {} ::constcl::MkOutputPort \
  {} ::constcl::OutputPort new
oo::class create ::constcl::StringOutputPort {
  superclass ::constcl::Port
  variable buffer
  constructor {args} {
    ::if {[llength $args]} {
      lassign $args str
      set buffer $str
    } else {
      set buffer {}
    }
  }
  method open {name} {}
  method close {} {}
  method put {str} {
    ::append buffer $str
    return
  }
  method newline {} {
    ::append buffer \n
  }
  method flush {} {}
  method tostring {} {
    MkString $buffer
  }
  method copy {} {
    ::constcl::StringOutputPort new $buffer
  }
  method tstr {} {
    regexp {(\d+)} [self] -> num
    return "#<string-output-port-$num>"
  }
}
interp alias {} ::constcl::MkStringOutputPort \
  {} ::constcl::StringOutputPort new

proc ::constcl::open-input-file {name} {
  assert "$name is a String" [string? $name]
  set port [InputPort new ${::#NIL}]
    \[info object class \$name]=[info object class $name]
    \[info object methods \$name]=[info object methods $name]
    set key [tclook::tclook $name]
    PrintView display $key
  try {
    $name string
  } on ok filename {
    try {
      $port config open $filename
    } on error msg {
      ::error $msg
    }
  } on error msg {
    ::error $msg
  }
  return $port
}


proc ::constcl::load {filename} {
  set port [open-input-file [String new $filename]]
  ::if {[$port query handle] ne ${::#NIL}} {
    set expr [read [$port query handle]]
    while {$expr ne "${::#EOF}"} {
      eval $expr
      set expr [read [$port query handle]]
    }
    close-input-port $port
  }
  $port destroy
}


proc ::assert {str expr {infoframe {}} {body {}}} {${::#t}}
  ::if {$infoframe eq {}} {
    set infoframe [info frame -2]
  }

  set truth [Boolean new [U [uplevel [::list expr $expr]]]]

  ::if {T{$truth}} {
    ::if {$body ne {}} {
      switch [dict get $infoframe type] {
        source {
          lappend r "file [file tail [dict get $infoframe file]]"
          lappend r "line [dict get $infoframe line]"
        }
        eval {
          lappend r "cmd  [dict get $infoframe cmd]"
          lappend r "proc [dict get $infoframe proc]"
          lappend r "line [dict get $infoframe line]"
        }
      }
      set resultList [::list "Failed assertion" $str [join $r ", "]]
      ::error [join $resultList ": "]
    } else {
      uplevel $body
    }
  }
  return {}
}


