package require tcltest
source constcl.tcl
namespace import -force tcltest::*

test macros-15.0 {expand put!} -body {
    pxw "(put! plist 'c 7)"
} -output "(let ((idx (list-find-key plist (quote c)))) (if (< idx 0) (set! plist (append (list (quote c) 7) plist)) (begin (list-set! plist (+ idx 1) 7) plist)))\n"

test macros-15.1 {run put!} -body {
    pew "(define plst (list 'a 1 'b 2 'c 3 'd 4 'e 5))"
    pew "(put! plst 'c 7)"
    pew "(put! plst 'f 6)"
    pew "plst"
} -output "(a 1 b 2 c 7 d 4 e 5)\n(f 6 a 1 b 2 c 7 d 4 e 5)\n(f 6 a 1 b 2 c 7 d 4 e 5)\n"

test macros-15.2 {expand put!} -body {
    pew "(define listname 'plist)"
    pew "(define key ''c)"
    pew "(define val 7)"
    pxw "`(let ((idx (list-find-key ,listname ,key))) (if (< idx 0) (set! ,listname (append (list ,key ,val) ,listname)) (begin (list-set! plist (+ idx 1) ,val) ,listname)))"
} -output "(let ((idx (list-find-key plist (quote c)))) (if (< idx 0) (set! plist (append (list (quote c) 7) plist)) (begin (list-set! plist (+ idx 1) 7) plist)))\n"


cleanupTests
return
